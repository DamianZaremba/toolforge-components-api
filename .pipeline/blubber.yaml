# syntax=docker-registry.wikimedia.org/repos/releng/blubber/buildkit:v0.22.0
version: v4
base: docker-registry.wikimedia.org/python3-bookworm:latest
variants:
  image:
    runs:
      environment:
        PORT: "8000"
        ADDRESS: "127.0.0.1"
        LOG_LEVEL: "info"
        STORAGE_TYPE: "kubernetes"
    lives:
      in: /components
    apt:
      packages:
        - git
    builders:
      - python:
          version: python3
          poetry:
            version: "==1.7.1"
          requirements:
            - pyproject.toml
            - poetry.lock

    copies:
      - local
    entrypoint:
      - bash
      - -c
      - poetry run uvicorn
        --factory components.main:create_app
        --workers=2
        --host=$ADDRESS
        --port=$PORT
        --log-level=$LOG_LEVEL
